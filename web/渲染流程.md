# 渲染流程

渲染流程由多个子阶段完成：
构建DOM树、构建CSSOM树、布局计算，分层，绘制，渲染

## 构建DOM树

1. 输入html
2. 浏览器解析html
3. 解析过程中可能遇到CSS或者JS相关文件或者代码，会暂定解析html，转而下载CSS文件和JS文件，并执行
4. 输出DOM树

## 构建CSSOM树

1. 读取CSS，转换为浏览器可以理解的StyleSheets
2. 转换样式表中属性值，使其标准化，比如 `1em`、`red` 等
3. 计算DOM树中每个节点的样式属性：继承和层叠规则，每个节点都包含有父节点的样式，如果有修改值，则进行合并替换；如果没有提供样式，则采用UserAgent，即浏览器默认样式
4. 将所有规则转化为树状结构，输出CSSOM树

## 布局计算

1. 合并DOM树和CSSOM树为Render树，只包含需要显示的节点和对应的样式
2. 计算每个节点在屏幕中的位置

## 分层

在绘制到界面之前需要针对一些特定的节点生成单独的图层，比如3D变换、页面滚动等，满足以下条件的节点会被提升成单独的一层

1. 拥有层叠上下文属性会被单独提升为一个图层
   1. 根属性（`html`）
   2. `position`
      1. `absolute`或者`relative`，但`z-index`不为`auto`
      2. `fixed`或者`sticky`
   3. `flex box`的子元素，且`z-index`不为`auto`
   4. `grid box`的子元素，且`z-index`不为`auto`
   5. `opacity`属性值小于1
   6. `mix-blend-mode`属性值不为`normal`
   7. `isolation`属性值为`isolate`
   8. 以下任意属性值不为node的元素：`transform`、`filter`、`backdrop-filter`、`perspective`、`clip-path`、`mask`/`mask-image`/`mask-border`
2. 需要裁剪的元素：固定大小的容器中发生内容溢出，会被单独提升为一个图层，滚动条又单独被提升为一层：
   1. document一层
   2. 滚动条一层
   3. 文本一层
