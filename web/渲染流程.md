# 渲染流程

渲染流程由多个子阶段完成：

1. 构建 DOM 树
   1. 输入 html
   2. 浏览器解析 html
   3. 解析过程中可能遇到 CSS 或者 JS 相关文件或者代码，外链CSS的下载不会阻塞html parse，但无论是外链还是内联都会阻塞渲染，外链会通过css parse并且会暂停html parse，内联通过html parse；js 的下载和解析都会阻塞 html parse 和渲染）
   4. 输出 DOM 树
2. 构建 CSSOM 树
   1. 读取 CSS，转换为浏览器可以理解的 StyleSheets
   2. 转换样式表中属性值，使其标准化，比如 `1em`、`red` 等
   3. 计算 DOM 树中每个节点的样式属性：继承和层叠规则，每个节点都包含有父节点的样式，如果有修改值，则进行合并替换；如果没有提供样式，则采用 UserAgent，即浏览器默认样式
   4. 将所有规则转化为树状结构，输出 CSSOM 树
3. 布局计算
   1. 合并 DOM 树和 CSSOM 树为 Render 树，只包含需要显示的节点和对应的样式
   2. 计算每个节点在屏幕中的位置
4. 分层
   1. 在绘制到界面之前需要针对一些特定的节点生成单独的图层，比如 3D 变换、页面滚动等，满足以下条件的节点会被提升成单独的一层
   2. 拥有层叠上下文属性会被单独提升为一个图层
      1. 根属性（`html`）
      2. `position`
         1. `absolute`或者`relative`，但`z-index`不为`auto`
         2. `fixed`或者`sticky`
      3. `flex box`的子元素，且`z-index`不为`auto`
      4. `grid box`的子元素，且`z-index`不为`auto`
      5. `opacity`属性值小于 1
      6. `mix-blend-mode`属性值不为`normal`
      7. `isolation`属性值为`isolate`
      8. 以下任意属性值不为 node 的元素：`transform`、`filter`、`backdrop-filter`、`perspective`、`clip-path`、`mask`/`mask-image`/`mask-border`
   3. 需要裁剪的元素：固定大小的容器中发生内容溢出，会被单独提升为一个图层，滚动条又单独被提升为一层：
      1. document 一层
      2. 滚动条一层
      3. 文本一层
5. 生成绘制列表绘制：把一个图层的绘制拆分成很多小的绘制指令，然后再把这些指令按照顺序组成一个待绘制列表
6. 栅格化：把绘制列表中的每一项绘制指令转换成位图，这个过程叫做栅格化
7. 合成与显示：合成线程把栅格化后的图层合成到一起，提交给浏览器进程，最后由其显示在屏幕上

其中渲染线程负责：DOM 树构建、CSSOM 树构建、布局计算、分层、生成绘制列表绘制，然后把绘制列表提交给合成线程，合成线程和光栅化线程负责：栅格化、合成，最后交给浏览器进程完成显示

一句话总结：

1. 渲染进程将 HTML 内容转换为能够读懂的 DOM 树 结构
2. 渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式。
3. 创建布局树，并计算元素的布局信息。
4. 对布局树进行分层，并生成分层树。
5. 为每个图层生成绘制列表，并将其提交到合成线程。
6. 合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。
7. 合成线程发送绘制图块命令 DrawQuad 给浏览器进程。
8. 浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上。

```text
html解析，构建DOM树
                              -->  构建布局树 --> 分层 --> 生成绘制列表 --> 栅格化 --> 合成与显示
CSS下载与解析，生成styleSheets
```
