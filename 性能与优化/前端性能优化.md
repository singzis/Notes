# 性能优化

## 关于阻塞 html 解析和页面渲染

- 浏览器解析遇到 CSS 样式资源时，CSS 会异步下载，不会阻塞浏览器构建 DOM 树，但是会阻塞渲染，在构建布局树时，会等 CSS 下载解析完毕后才进行（防止 CSS 规则不断变化）
- 浏览器解析遇到 JS 脚本资源时，需要等待 JS 脚本下载完成并执行后才会继续解析 HTML；但是当脚本加上 defer 与 async 时又不一样，defer 是延迟执行，但会在DOMContentLoaded前解析执行，async 是异步执行，下载完即执行；
- CSS 加载会阻塞后面的的 JS 语句的执行，因为 HTML5 标准中有一项规定，浏览器在执行 Script 脚本前，必须保证当前的的外联 CSS 已经解析完成，因为 JS 可能会去获取或者变更 DOM 的 CSS 样式，如果此时外联 CSS 还没解析好，获取到的结果就是不准确的；
- style 标签中的内容是通过 html parse 解析的
- 解析遇到 Img 图片 时，直接异步下载，不会阻塞解析；下载完毕后用图片替换原有 src 的地方；

总结：

- CSS 会阻塞浏览器渲染，不会阻塞html parse；
- JS 会阻塞浏览器解析和渲染；
- CSS 会阻塞后面的 JS 执行，该JS如果非defer或者async的话，会影响html parse；
- IMG 不会阻塞；

解决办法：

1. 将 CSS 文件放在 head 中
   1. 外链 css 无论放在 html 的任何位置都不会影响 html 的解析，但是会影渲染；
   2. 如果将 css 放在尾部，html 的解析不受影响，浏览器会在 css 样式加载解析完后，重新计算样式绘制，造成回流重绘、页面闪动等现象；
   3. 而如果将 css 放在头部，css 的下载解析时可以和 html 的解析并行，并且会等待 css 下载解析完毕后开始绘制；
2. 媒体查询减少不必要的 CSS 的下载
   1. 例如`<link rel="stylesheet" media="screen and (min-width: 900px)" href="example.CSS">`，该样式表不会阻塞，因为媒体查询不匹配，仅在初次渲染时，页面宽度小于 900px 时，才会阻塞
3. 将 JS 文件放在 body 底部，尽量减少 JS 文件的体积，减少下载时间
   1. 因为当浏览器解析到 script 时，就会立即下载执行，中断 html 的解析过程，因为 js 可能会修改 dom 元素；如果外部脚本加载时间长，就会造成网页长时间未响应；
4. 异步下载 JS
   1. defer：异步进行下载，然后等待 HTML 解析完成后（DOM 完成构建，DOMContentLoaded 事件会在 defer 脚本执行完后再触发）执行，有多个设置 defer 的脚本时，按照下载顺序进行
   2. async：异步进行下载，下载完成后会立即执行，执行时仍然会阻塞，有多个设置 async 的脚本时，谁先下载完就先执行
   3. 如果同时使用 async 和 defer 属性，defer 不起作用，浏览器行为由 async 属性决定

## 减少回流（重排）重绘

记住引起元素大小或位置改变的情况，均会触发回流（Reflow）。反之，大小位置不变的情况（如颜色样式 color、background-color、outline-style 改变），就发生重绘 (Repaint)。回流必将引起重绘，重绘不一定引起回流。所以回流的性能开销更大

### 哪些情况引起回流

1. 页面首次渲染
2. 浏览器窗口变化
3. 元素尺寸或位置变化（宽高、边距、边框等）
4. 元素内容发生变化（文字数量、图片大小、字体大小变化）
5. 添加删除可见的 DOM 节点
6. 激活 CSS 伪类（hover、active 等）
7. 查询某些属性或调用某些方法（浏览器会必须回流来保证数据的准确性）

注意：

1. outline-width、box-shadow、border-radius 这些属性并不会引起元素大小的改变，而是样式形状的改变，所以属于重绘
2. visibility 属性改变只会导致重绘，因为 visibility 控制的元素大小位置是不变的
3. opacity 属性是通过触发 CSS3 硬件加速（GPU 渲染）来实现的，所以不会引起回流重绘。（常见的触发硬件加速属性有：transform、opacity、filter 等）

### 如何减少回流重绘

1. HTML 层面
   1. 避免使用 table 布局
   2. 在 DOM 树最末端改变 class
2. CSS 层面
   1. 尽量减少使用 CSS 表达式（例如：calc()）
   2. 避免使用高性能消耗的 CSS 选择器（例如：#id）
   3. 将动画效果应用到 position 属性为 absolute 或 fixed 的元素上
   4. 避免使用 CSS 滤镜（例如：blur）
   5. 避免使用 CSS table 布局
   6. 尽量使用 CSS3 动画，避免使用 JS 实现动画效果
3. JS 层面
   1. 避免用 JS 操作样式（多个样式改变尽量合并为一次操作）
   2. 如无法避免多次应用样式或操作 DOM，则可以先设置元素隐藏（先 display:none 再操作）
   3. 重复使用元素属性时赋值给变量（避免重复查询元素导致回流）
   4. 某些操作尽量采用防抖节流（如 resize、scroll）
